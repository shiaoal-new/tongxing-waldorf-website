<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>學校網站內容管理</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hithismani/responsive-decap@main/dist/responsive.css">
    <link rel="stylesheet" href="admin.css">
    <!-- 引入 YAML 解析器 -->
    <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>

<script>
    // 告知 CMS 我們要手動初始化，避免它自動抓取 default config.yml
    window.CMS_MANUAL_INIT = true;
</script>
<script src="https://unpkg.com/decap-cms@^3.0/dist/decap-cms.js"></script>
<script>
    async function initCMS() {
        try {
            // 判斷是否為本地開發環境
            const isLocal = window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1';

            // 根據環境選擇配置文件
            const configFile = isLocal ? 'config.local.yml' : 'config.base.yml';

            console.log(`載入配置: ${configFile} (環境: ${isLocal ? '本地開發' : '生產環境'})`);

            // 加載配置
            const [configBaseRes, collectionsRes] = await Promise.all([
                fetch(configFile),
                fetch('collections.yml')
            ]);

            const [configBaseText, collectionsText] = await Promise.all([
                configBaseRes.text(),
                collectionsRes.text()
            ]);

            const config = jsyaml.load(configBaseText);
            const collections = jsyaml.load(collectionsText);

            config.collections = collections;

            // 確保 CMS 已經準備好 init 方法
            if (window.CMS) {
                window.CMS.init({ config });
            }
        } catch (error) {
            console.error("CMS 初始化失敗:", error);
        }
    }

    // 執行初始化
    initCMS();

    // 等待 DOM 準備好後再啟動 MutationObserver
    document.addEventListener('DOMContentLoaded', () => {
        // 高級優化:自動將 Label 文字填充到空的 Placeholder 中,並優化 UI 體驗
        const observer = new MutationObserver(() => {
            const controls = document.querySelectorAll('[class*="ControlContainer"]');
            controls.forEach(container => {
                const label = container.querySelector('label[class*="FieldLabel-"]');
                const input = container.querySelector('input, textarea, select');

                if (label && input) {
                    const rawText = label.textContent || "";
                    const isOptional = rawText.includes("(optional)");
                    const cleanText = rawText.replace("(optional)", "").trim();

                    // 自動填充 Placeholder (如果為空)
                    if (!input.placeholder) {
                        input.placeholder = cleanText;
                    }

                    // 將 Label 文字設為原生 Tooltip (title 屬性)
                    if (!input.title) {
                        input.title = cleanText;
                    }

                    // 處理必填紅星:如果原本不含 (optional) 且還沒加過星號,就加一個
                    if (!isOptional && !label.querySelector(".required-star")) {
                        label.insertAdjacentHTML("beforeend", '<span class="required-star">*</span>');
                    }
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    });
</script>
</body>

</html>