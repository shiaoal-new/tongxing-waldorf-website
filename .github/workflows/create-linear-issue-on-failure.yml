name: Create Linear Issue on Failure

on:
    workflow_run:
        workflows: ["Firebase Hosting Deploy"]
        types:
            - completed

jobs:
    create-linear-issue:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                  ref: ${{ github.event.workflow_run.head_sha }}
                  fetch-depth: 0

            - name: Get commit information
              id: commit-info
              run: |
                  COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
                  COMMIT_MSG=$(git log -1 --pretty=format:"%s" $COMMIT_SHA)
                  COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" $COMMIT_SHA)

                  echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
                  echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
                  echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT

            - name: Get workflow errors
              id: get-errors
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  RUN_ID="${{ github.event.workflow_run.id }}"

                  # ç²å– jobs è³‡è¨Š
                  JOBS_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                    "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs")

                  # æå–å¤±æ•—çš„æ­¥é©Ÿ
                  ERROR_SUMMARY=$(echo "$JOBS_JSON" | jq -r '
                    .jobs[] | 
                    select(.conclusion == "failure") | 
                    "### âŒ Job: " + .name + "\n\n" +
                    ([.steps[] | select(.conclusion == "failure") | "- **æ­¥é©Ÿ:** " + .name + "\n  **ç‹€æ…‹:** " + .conclusion] | join("\n")) +
                    "\n\n"
                  ' | head -c 2000)

                  # å¦‚æœæ²’æœ‰éŒ¯èª¤æ‘˜è¦,ä½¿ç”¨é è¨­è¨Šæ¯
                  if [ -z "$ERROR_SUMMARY" ]; then
                    ERROR_SUMMARY="ç„¡æ³•è‡ªå‹•æå–éŒ¯èª¤è©³æƒ…,è«‹æŸ¥çœ‹ workflow é‹è¡Œæ—¥èªŒã€‚"
                  fi

                  # ä¿å­˜åˆ°ç’°å¢ƒè®Šæ•¸
                  echo "summary<<EOF" >> $GITHUB_OUTPUT
                  echo "$ERROR_SUMMARY" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create Linear Issue
              env:
                  LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
              run: |
                  # æ§‹å»º issue æè¿°
                  cat > /tmp/description.md <<'DESCRIPTION_EOF'
                  ## ğŸš¨ éƒ¨ç½²å¤±æ•—é€šçŸ¥

                  **Workflow:** ${{ github.event.workflow_run.name }}
                  **åˆ†æ”¯:** `${{ github.event.workflow_run.head_branch }}`
                  **Commit:** `${{ steps.commit-info.outputs.sha }}`
                  **ä½œè€…:** ${{ steps.commit-info.outputs.author }}
                  **Commit è¨Šæ¯:** ${{ steps.commit-info.outputs.message }}

                  ---

                  ## ğŸ“‹ éŒ¯èª¤æ‘˜è¦

                  ${{ steps.get-errors.outputs.summary }}

                  ---

                  ## ğŸ”— ç›¸é—œé€£çµ

                  - [æŸ¥çœ‹ Workflow é‹è¡Œ](${{ github.event.workflow_run.html_url }})
                  - [æŸ¥çœ‹ Commit](https://github.com/${{ github.repository }}/commit/${{ steps.commit-info.outputs.sha }})

                  ---

                  ## ğŸ“ å»ºè­°æ“ä½œ

                  1. æŸ¥çœ‹ä¸Šæ–¹çš„éŒ¯èª¤æ‘˜è¦
                  2. é»æ“Š Workflow é€£çµæŸ¥çœ‹å®Œæ•´æ—¥èªŒ
                  3. æª¢æŸ¥ç›¸é—œçš„ä»£ç¢¼è®Šæ›´
                  4. åœ¨æœ¬åœ°é‡ç¾ä¸¦ä¿®å¾©å•é¡Œ
                  5. é‡æ–°éƒ¨ç½²æ¸¬è©¦

                  ---

                  *æ­¤ issue ç”± GitHub Actions è‡ªå‹•å‰µå»º*
                  DESCRIPTION_EOF

                  DESCRIPTION=$(cat /tmp/description.md)
                  TITLE="ğŸš¨ éƒ¨ç½²å¤±æ•—: ${{ github.event.workflow_run.head_branch }} - ${{ steps.commit-info.outputs.sha }}"

                  # è½‰ç¾© JSON
                  DESCRIPTION_JSON=$(echo "$DESCRIPTION" | jq -Rs .)
                  TITLE_JSON=$(echo "$TITLE" | cut -c1-100 | jq -Rs .)

                  # å‰µå»º GraphQL mutation
                  cat > /tmp/mutation.json <<EOF
                  {
                    "query": "mutation CreateIssue(\$input: IssueCreateInput!) { issueCreate(input: \$input) { success issue { id identifier title url } } }",
                    "variables": {
                      "input": {
                        "teamId": "36c52d63-f2e6-4c68-a21b-23e8870ff5da",
                        "title": $TITLE_JSON,
                        "description": $DESCRIPTION_JSON,
                        "priority": 1,
                        "labelIds": ["fca6f13a-3b0d-41cc-9ffe-76ab03f4fab0"],
                        "stateId": "fdf009d4-2ad2-4765-97ba-0a81b09e7825"
                      }
                    }
                  }
                  EOF

                  # ç™¼é€è«‹æ±‚åˆ° Linear
                  RESPONSE=$(curl -s -X POST \
                    -H "Content-Type: application/json" \
                    -H "Authorization: $LINEAR_API_KEY" \
                    -d @/tmp/mutation.json \
                    https://api.linear.app/graphql)

                  # æª¢æŸ¥çµæœ
                  SUCCESS=$(echo "$RESPONSE" | jq -r '.data.issueCreate.success // false')

                  if [ "$SUCCESS" = "true" ]; then
                    ISSUE_ID=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.identifier')
                    ISSUE_URL=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.url')
                    
                    echo "âœ… Linear issue å‰µå»ºæˆåŠŸ!"
                    echo "ğŸ“‹ Issue ID: $ISSUE_ID"
                    echo "ğŸ”— URL: $ISSUE_URL"
                    
                    # æ·»åŠ åˆ° GitHub Actions summary
                    cat >> $GITHUB_STEP_SUMMARY <<SUMMARY_EOF
                  ## âœ… Linear Issue å·²å‰µå»º

                  - **Issue:** [$ISSUE_ID]($ISSUE_URL)
                  - **Workflow:** ${{ github.event.workflow_run.name }}
                  - **Branch:** ${{ github.event.workflow_run.head_branch }}
                  - **Commit:** ${{ steps.commit-info.outputs.sha }}
                  - **Author:** ${{ steps.commit-info.outputs.author }}

                  [æŸ¥çœ‹ Linear Issue â†’]($ISSUE_URL)
                  SUMMARY_EOF
                  else
                    ERROR_MSG=$(echo "$RESPONSE" | jq -r '.errors[0].message // .errors[0].extensions.userPresentableMessage // "Unknown error"')
                    echo "âŒ å‰µå»º Linear issue å¤±æ•—"
                    echo "éŒ¯èª¤: $ERROR_MSG"
                    echo "å®Œæ•´éŸ¿æ‡‰: $RESPONSE"
                    exit 1
                  fi
